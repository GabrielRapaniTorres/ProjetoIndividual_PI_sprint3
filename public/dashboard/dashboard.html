<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="icon"
        href="../assets/imgs/png-transparent-music-note-music-note-musical-notes-musical-design-symbol-sound-melody-music-notes-v.svg">
</head>

<style>
    .fundo {
        background-image: url(../assets/imgs/luxa.org-opacity-changed-._van-gogh-noite-estrelada-sobre-rodano-d.jpg);
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
    }

    .janela {
        color: #cbccd1;
        align-self: center;
        justify-self: center;
        padding: 40px;
        width: 80%;
        height: max-content;
        border-radius: 10px;
        margin-top: 20px;
        margin-bottom: 20px;
        background-color: #1a1a2ed8;
        box-shadow: 5px 2px 8px rgba(5, 7, 37, 0.753);
    }

    .header-left {
        width: 30%;
        padding: 20px;
        float: left;
    }

    .header-left h1 {
        font-size: 2.5em;
        margin-bottom: 20px;
    }

    .header-left .hello {
        font-size: 1.2em;
        margin-bottom: 20px;
    }

    .header {
        background-color: rgba(0, 0, 0, 0.7);
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .navbar {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        justify-content: center;
    }

    .grafico {
        height: 500px;
        width: 100%;
        margin-left: 100px;
        margin-bottom: 40px;
        width: 40%;
    }

    .h1Container {
        font-family: "Cedarville Cursive", cursive;
        width: 100%;
        display: flex;
        margin-bottom: 40px;
        font-style: normal;
        justify-content: center;
    }

    .dash-cont {
        width: 90%;
        display: flex;
        margin-left: 40px;
    }

    .graficoUsuarios {
        justify-self: center;
        align-self: center;
        width: 35%;
        margin-left: 90px;
    }

    .divKpi {
        display: flex;
        justify-content: center;
        flex-direction: row;
        margin-bottom: 40px;
    }

    .divKpi div {
        width: max-content;
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        font-size: 15px;
        height: max-content;
        margin-right: 40px;
        margin-left: 40px;
        padding: 20px;
        background-color: #2e2e4d;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        border-radius: 20px;

    }
</style>

<body>
    <div class="fundo">

        <div class="header">
            <div class="container">
                <h1 class="titulo">VibeTrack</h1>
                <ul class="navbar">
                    <li>
                        <a href="../index.html">inicio</a>
                    </li>
                    <li>
                        <a href="../simulador.html">Sobre</a>
                    </li>
                    <li>
                        <a href="../login.html">Login</a>
                    </li>
                    <li>
                        <a href="../cadastro.html">Cadastro</a>
                    </li>
                    <li>
                        <a href="cards.html">quiz</a>
                    </li>
                    <li class="agora">
                        <a href="dashboard.html">dashboard</a>
                    </li>
                    <li>
                        <a href="mural.html">forum</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="h1Container">
        <h1>Bem vindo a sua pagina da dashboard</h1>
    </div>
    <div class="divKpi">
        <div class="KPI"></div>
    </div>

    <div class="dash-cont">

        <div class="grafico">
            <div style="text-align:center; margin-bottom: 20px;">
                <label for="filtroGrafico">Visualizar:</label>
                <select id="filtroGrafico" onchange="atualizarGraficoGeral()">
                    <option value="usuario">Meus resultados</option>
                    <option value="geral">Acertos da comunidade</option>
                    <option value="errosCom">Erros na comunidade</option>
                </select>
            </div>
            <canvas id="myChart"></canvas>
        </div>

        <div class="graficoUsuarios">
             <div style="text-align:center; margin-bottom: 20px;">
        <label for="filtroEstilo">Visualizar:</label>
        <select id="filtroEstilo" onchange="atualizarGraficoEstilos()">
            <option value="usuarios">Usuários por estilo</option>
            <option value="acertos">Acertos por estilo</option>
        </select>
    </div>
            <canvas id="myChart2"></canvas>
        </div>


    </div>

    <footer>
        <p>©VibeTrack 2025</p>
        <div>
            <h2>Desenvolvido por Gabriel Rapani Torres, com o auxilio dos professores (SPtech)</h2>
        </div>
        <p>version 1.0</p>
    </footer>

</body>

</html>

<script>
    async function atualizarGraficoGeral() {
        const ctx = document.getElementById('myChart').getContext('2d');
        const filtro = document.getElementById('filtroGrafico')?.value || 'usuario';
        let acertos = 0, erros = 0;

        if (filtro === 'usuario') {
            const idUsuario = sessionStorage.ID_USUARIO || localStorage.ID_USUARIO;
            if (!idUsuario) {
                console.error("Usuário não logado!");
                return;
            }
            const resposta = await fetch(`/quiz/estatisticas-usuario/${idUsuario}`);
            const dados = await resposta.json();
            dados.forEach(item => {
                if (item.correta === 1) acertos = item.quantidade;
                else erros = item.quantidade;
            });

            const kpiDivs = document.querySelectorAll('.KPI');
            if (kpiDivs[0]) {
                kpiDivs[0].innerHTML = `<b>Acertos:</b> ${acertos} <br> <b>Erros:</b> ${erros}`;
            }

            if (window.myChartInstance) window.myChartInstance.destroy();

            window.myChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Erros', 'Acertos'],
                    datasets: [{
                        data: [erros, acertos],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Seus acertos/erros' }
                    }
                }
            });
        } else {
            const idUsuario = sessionStorage.ID_USUARIO || localStorage.ID_USUARIO;
            if (!idUsuario) {
                console.error("Usuário não logado!");
                return;
            }

            let acertosUsuario = 0;
            try {
                const respostaUsuario = await fetch(`/quiz/estatisticas-usuario/${idUsuario}`);
                const dadosUsuario = await respostaUsuario.json();
                dadosUsuario.forEach(item => {
                    if (item.correta === 1) acertosUsuario = item.quantidade;
                });
            } catch (error) {
                console.error("Erro ao buscar acertos do usuário:", error);
            }

            let acertosGeral = 0;
            try {
                const respostaGeral = await fetch(`/quiz/estatisticas-geral`);
                const dadosGeral = await respostaGeral.json();
                dadosGeral.forEach(item => {
                    if (item.correta === 1) acertosGeral = item.quantidade;
                });
            } catch (error) {
                console.error("Erro ao buscar acertos gerais:", error);
            }

            const acertosOutros = Math.max(acertosGeral - acertosUsuario, 0);



            if (window.myChartInstance) window.myChartInstance.destroy();

            window.myChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Outros usuários', 'Você'],
                    datasets: [{
                        data: [acertosOutros, acertosUsuario],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Sua participação nos acertos da comunidade' }
                    }
                }
            });
        }
        if (filtro === 'usuario') {
        } else if (filtro === 'geral') {
        } else if (filtro === 'errosCom') {
            const idUsuario = sessionStorage.ID_USUARIO || localStorage.ID_USUARIO;
            if (!idUsuario) {
                console.error("Usuário não logado!");
                return;
            }

            let errosUsuario = 0;
            try {
                const respostaUsuario = await fetch(`/quiz/estatisticas-usuario/${idUsuario}`);
                const dadosUsuario = await respostaUsuario.json();
                dadosUsuario.forEach(item => {
                    if (item.correta === 0) errosUsuario = item.quantidade;
                });
            } catch (error) {
                console.error("Erro ao buscar erros do usuário:", error);
            }

            let errosGeral = 0;
            try {
                const respostaGeral = await fetch(`/quiz/estatisticas-geral`);
                const dadosGeral = await respostaGeral.json();
                dadosGeral.forEach(item => {
                    if (item.correta === 0) errosGeral = item.quantidade;
                });
            } catch (error) {
                console.error("Erro ao buscar erros gerais:", error);
            }

            const errosOutros = Math.max(errosGeral - errosUsuario, 0);

            if (window.myChartInstance) window.myChartInstance.destroy();

            window.myChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Outros usuários', 'Você'],
                    datasets: [{
                        data: [errosOutros, errosUsuario],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Sua participação nos erros da comunidade' }
                    }
                }
            });
        }
    }
    async function atualizarGraficoEstilos() {
    const ctx2 = document.getElementById('myChart2').getContext('2d');
    const filtro = document.getElementById('filtroEstilo')?.value || "usuarios";

    // Destroi o gráfico anterior, se existir
    if (window.myChart2Instance) window.myChart2Instance.destroy();

    if (filtro === "usuarios") {
        try {
            const resposta = await fetch('/usuarios/usuarios-por-estilo');
            const dados = await resposta.json();
            const labels = dados.map(item => item.estilo);
            const valores = dados.map(item => item.quantidade);

            window.myChart2Instance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Usuários por estilo',
                        data: valores,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Usuários por gênero musical' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao buscar usuários por estilo:", error);
        }
    } else if (filtro === "acertos") {
        try {
            const resposta = await fetch('/quiz/acertos-por-estilo');
            const dados = await resposta.json();
            const labels = dados.map(item => item.estilo);
            const valores = dados.map(item => item.acertos);

            window.myChart2Instance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Acertos por estilo',
                        data: valores,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Acertos por gênero musical' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao buscar acertos por estilo:", error);
        }
    }
}

    atualizarGraficoGeral();
    atualizarGraficoEstilos();
</script>